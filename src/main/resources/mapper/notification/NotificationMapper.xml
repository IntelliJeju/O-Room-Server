<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.savit.notification.mapper.NotificationMapper">

    <resultMap id="PushNotificationResult" type="com.savit.notification.domain.PushNotification">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="fcmToken" column="fcm_token"/>
        <result property="title" column="title"/>
        <result property="body" column="body"/>
        <result property="type" column="type"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="sentAt" column="sent_at"/>
        <result property="errorMessage" column="error_message"/>
    </resultMap>

    <resultMap id="UserFcmTokenResult" type="com.savit.notification.domain.UserFcmToken">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="fcmToken" column="fcm_token"/>
        <result property="deviceType" column="device_type"/>
        <result property="isActive" column="is_active"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 푸시 알림 이력 저장 -->
    <insert id="insertNotification" parameterType="com.savit.notification.domain.PushNotification">
        INSERT INTO PushNotifications (
            user_id, fcm_token, title, body, type, status,
            created_at, sent_at, error_message
        ) VALUES (
                     #{userId}, #{fcmToken}, #{title}, #{body}, #{type}, #{status},
                     #{createdAt}, #{sentAt}, #{errorMessage}
                 )
    </insert>

    <!-- 사용자 FCM 토큰 저장 -->
    <insert id="insertUserFcmToken">
        INSERT INTO UserFcmTokens (
            user_id, fcm_token, device_type, is_active, created_at, updated_at
        ) VALUES (
                     #{userId}, #{fcmToken}, #{deviceType}, TRUE, NOW(), NOW()
                 )
    </insert>

    <!-- 기존 토큰 비활성화 -->
    <update id="deactivateUserTokens">
        UPDATE UserFcmTokens
        SET is_active = FALSE, updated_at = NOW()
        WHERE user_id = #{userId}
          AND device_type = #{deviceType}
          AND is_active = TRUE
    </update>

    <!-- 사용자의 활성 토큰 조회 -->
    <select id="findActiveTokensByUserId" resultMap="UserFcmTokenResult">
        SELECT id, user_id, fcm_token, device_type, is_active, created_at, updated_at
        FROM UserFcmTokens
        WHERE user_id = #{userId}
          AND is_active = TRUE
        ORDER BY updated_at DESC
    </select>

    <!-- 특정 디바이스 타입의 토큰 조회 -->
    <select id="findTokenByUserIdAndDeviceType" resultMap="UserFcmTokenResult">
        SELECT id, user_id, fcm_token, device_type, is_active, created_at, updated_at
        FROM UserFcmTokens
        WHERE user_id = #{userId}
          AND device_type = #{deviceType}
          AND is_active = TRUE
        ORDER BY updated_at DESC
        LIMIT 1
    </select>

</mapper>